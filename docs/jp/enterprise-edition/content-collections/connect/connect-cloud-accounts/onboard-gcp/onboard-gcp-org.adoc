:topic_type: タスク
[.task]
== GCP 組織のオンボーディング

データを取り込んで監視するために、GCP組織をPrisma Cloudに追加します。

Prisma CloudにGCPアカウントを追加するには、ここから作業を開始してください。GCPプロジェクトをPrisma Cloudに追加しており、そのプロジェクトが所属するGCP組織を追加する場合、Prisma Cloudで既存のGCPプロジェクトは組織下に移動されます。

GCP組織をPrisma Cloudに追加するときに、組織のアセット階層で含めるまたは除外するフォルダとプロジェクトを指定できます。

[.procedure]
. *[Settings(設定)] > [Providers(プロバイダー)]* から*[Connect Provider(プロバイダーに接続)] > [Cloud Account(クラウドアカウント)]*を選択します。

. オンボーディングするクラウドアカウントとして*Google Cloud Platform*を選択し、*開始*をクリックします。
+
image::connect/gcp-add-org-1.png[]

.. セキュリティのカバレッジを広げるには、[*対象範囲*] の [*組織*] を選択します。

.. GCP 組織で有効にしたい[*セキュリティ機能とアクセス許可*] を選択します。
+
機能は*Foundational （基礎）*と*詳細*にグループ分けされています。選択内容に基づいて、Prisma Cloud は、サービス アカウントに関連付けられた権限を含むTerraformスクリプトを動的に生成します。
+
* 組織のクラウド導入の開始時に *Foundational （基礎）* (推奨) 機能を使用して、クラウドとオンプレミスの資産を効果的に管理します。
+
*Foundational （基礎）* 機能はデフォルトで有効になっています。
+
** *設定誤り*は、クラウドアセットのスキャンとメタデータの取り込みに必要な権限を付与します。
** *Identity Security*は、IDの正味有効権限の計算とアクセスの管理に必要な権限を付与します。
** xref:../../../runtime-security/agentless-scanning/agentless-scanning.adoc[エージェントレスワークロードスキャン]（デフォルトで選択されている）を有効にして追加すると、Defenderをインストールしなくてもホストとコンテナの脆弱性とコンプライアンスリスクをスキャンできます。エージェントレスワークロードスキャン機能を使いたくない場合は、このチェックボックスを選択解除できます。組織をオンボードすると、スキャンが自動的に開始されます。エージェントレススキャンのスキャンxref:../../../runtime-security/agentless-scanning/onboard-accounts/onboard-accounts.adoc[設定]を更新することもできます。
+
* *詳細*（追加）機能により、クラウド運用をプロアクティブに制御し、ランタイム環境内で問題が顕在化する前に特定し修正することができます。
+
有効にするように選択できる *詳細* 機能は次のとおりです。
+
** *脅威検知* (デフォルトで有効) は、ネットワーク、ID の脅威を検出するために必要な権限を付与します。
** AWS Lambda、Azure、Googleなどのクラウドプロバイダの関数のxref:../../../runtime-security/vulnerability-management/scan-serverless-functions.adoc[脆弱性]とxref:../../../runtime-security/compliance/visibility/serverless.adoc[コンプライアンス]をスキャンするための*サーバーレスファンクションスキャン*を有効化し、権限を追加します。組織をオンボードすると、スキャンが自動的に開始されます。サーバーレススキャンのxref:../../../runtime-security/agentless-scanning/onboard-accounts/onboard-accounts.adoc[スキャン]設定を更新することもできます
** *Agent-Based Workload Protection*に権限を追加し、安全なクラウドxref:../../../runtime-security/install/deploy-defender/host/auto-defend-host.adoc[VM]、xref:../../../runtime-security/install/deploy-defender/container/container.adoc[コンテナ]、およびxref:../../../runtime-security/install/deploy-defender/kubernetes/kubernetes.adoc[Kubernetesオーケストレーター]に保護するためのxref:../../../runtime-security/install/deploy-defender/defender-types.adoc[Defenderの自動デプロイ]を可能にします。防御側が必要とするレジストリ スキャン、Kubernetes 監査、およびその他の機能も有効になっています。
+
NOTE: *エージェントレスワークロードスキャン*と*サーバーレス機能スキャン*を選択すると、*組織スキャン*の切り替えが可能になります。*オン*に切り替えると、組織にリンクされているすべてのアカウントがスキャンされます。

.. *次へ*をクリックします。

. *アカウントを設定します*。
+
image::connect/gcp-add-org-2.png[] 

.. *組織 ID*と *アカウント名*を入力します。
+
クラウドアカウント名が自動的に記入されます。この名前を、Prisma CloudでGCPプロジェクトを独自に識別するための、別のクラウドアカウント名に置き換えることができます。
+
組織階層下のすべてのGCPプロジェクトが、現在および将来に渡って、Prisma Cloudにより監視されます。GCP組織IDを検索するには、https://console.cloud.google.com[GCPコンソール]にログインして、組織をクリックします。
+
image::connect/gcp-organization-info.png[]

.. (tt:[任意])[*修正*]を有効にすると、Prisma Cloudの修正可能な構成ポリシーについて報告されたポリシー違反に対処できます。この機能は、デフォルトでは有効になっていません。有効にすると、Prisma Cloud ロールは Google クラウド アカウントへの読み取り/書き込みアクセス許可を取得し、修復コマンドを正常に実行できるようになります。

.. (tt:[任意])*フローログ*を有効にします。
+
*フローログストレージバケット*の名前と (tt:[任意])*データフロー対応プロジェクト ID*（Cloud Dataflowサービスを有効にしたプロジェクト ID）を入力します。このプロジェクトが、VPCフローログの送信先であればベストです。
+
Terraformテンプレートではフローログが有効になっていないため、フローログを取得するためにはPrisma Cloud の xref:enable-flow-logs-for-gcp-organization.adoc[GCP 組織の フローログを有効にする] のワークフローを完了させる必要があります。また、Prisma Cloudでフローログ圧縮を有効にして、GCPで設定されている、フローログシンクにネイティブ圧縮機能が用意されていない問題に対処する場合も、同様に手動で作業を行う必要があります。xref:flow-logs-compression.adoc[フローログ圧縮]を有効にすると、Prisma Cloudはフローログ圧縮に必要なネットワークおよび演算アセットを設定します。この処理には、最長で5分ほどかかります。
+
[NOTE]
====
フローログを有効にすると、過去7日間のフローログデータが取り込まれます。フローログを手動で無効にした、API権限を変更した、または内部エラーが発生したなど、何らかの理由でフローログを利用できなくなった場合、アクセスが回復すると、そこから過去の7日間のログのみが取得されます。
====

.. Prisma Cloud向けの*サービスアカウント*を設定します。
+
サービスアカウントは、個別のユーザーアカウントを作成する代わりに、きめ細かく権限を与えることができるIDです。GCP組織階層内のすべてのGCPプロジェクトを監視するには、サービスアカウントに4つのロールが必要になります。4つのロールのうち3つは、GCPプロジェクトレベルで権限を割り当てる場合と共通のロールです。それに加えて組織のプロパティへのアクセスを許可するために、Organization Role Viewer（組織ロール閲覧者）ロールが必要になります。
+
* Viewer（閲覧者）—初期ロール。
* (tt:[Prisma Cloudランタイムセキュリティでは必須、Prisma Cloudでは任意]) Compute Security Admin（コンピュートセキュリティ管理者）-事前定義されたロール。
* Prisma Cloud Viewer— カスタムロール。
* Organization Role Viewer（組織ロール閲覧者）—事前定義されているロール。
* Folder Viewer（フォルダ閲覧者）—事前定義されているロール。

.. *Terraform Script をダウンロード*し、*手順*に従って*サービスアカウントキー (JSON)* ファイルをアップロードします。
+
ダウンロードしたTerraformテンプレートを保管するディレクトリを作成することをお勧めします。そうすることで、Prisma Cloudに別のGoogle組織を追加する際に、テンプレートを管理することができます。ディレクトリには、使用する組織を一意に識別できる名前（例：onboard-<組織-名>）を付けてください。

.. Prisma Cloudに追加するプロジェクトを選択します。Prisma Cloudでは、*すべてのプロジェクト（デフォルト）*を選択することを推奨しています。
+
image::connect/gcp-add-proj-4.png[] 
+
次の項目を含めるように選択できます。
+
* 組織階層に含まれる*すべてのプロジェクト*。
* *サブセットを含めるか*、プロジェクトの*サブセットを除外します*。関連するタブを選択し、含めるか除外するプロジェクトを選択します。
+
フォルダを選択すると、そのフォルダまたはサブフォルダ内のすべての既存のプロジェクトがPrisma Cloudにオンボードされます。定期同期では、後でクラウドプラットフォームに追加した新しいプロジェクトとサブフォルダがチェックされ、Prisma Cloudに追加されます。

.. 不足している権限またはエラーを解決します。
+
サービスアカウントに監視対象プロジェクトを選択するための適切な権限がない場合、次の警告メッセージが表示されます。
+
image::connect/gcp-add-org-error-1.png[]
+
[NOTE]
====
フォルダへのアクセス許可がない場合、*自動作成*とGCPアセット階層に基づいてアカウントグループを再帰的に作成するオプションは無効になります。
====
+
サービスアカウントが削除または無効になった場合、またはGoogle Cloudコンソールでキーが削除されると、次のエラーが表示されます。
+
image::connect/gcp-add-org-error-2.png[]
+
サービス アカウント キーを更新して、オンボーディング プロセスを続行します。

.. *アカウントグループ*の割り当て
+
このGCP組織にアカウントグループを割り当てるには、2つのオプションがあります。*アカウントグループの自動作成*を有効または無効にして、アカウントグループを手動で選択します。
+
* *アカウントグループの自動作成*を無効にすると、アカウントグループを選択して GCP 組織に割り当てることができます。
* *アカウントグループの自動作成*を有効にし、*再帰階層*を有効にすると、アカウントグループが作成され、GCP組織階層内にネストされているフォルダにマッピングされます。
* *アカウントグループの自動作成*を有効にし、*再帰階層*を無効にすると、 GCP 組織階層の最上位フォルダごとにアカウントグループが作成およびマッピングされます。
+
「*フォルダのサブセットを除外する*」を選択した場合、*アカウントグループの自動作成*が有効になっていると、*再帰階層を維持する*機能が無効になります。
+
アカウントグループを再帰的に作成することを選択した場合、各アカウントグループには、階層的なフォルダ構造内にネストされたすべてのGCPプロジェクトのリストがGCPコンソールに表示されます。アカウントグループはPrisma Cloudのフラット構造で編成されているため、マッピングを視覚的に確認することはできません。
+
自動的に作成されるxref:../../../administration/create-manage-account-groups.adoc[アカウントグループ]はアイコンで示され、Prisma Cloudで編集することはできません。
+
Prisma Cloud上の異なるアカウントグループにアカウントを選択的に割り当てたい場合は、xref:../../../administration/create-manage-account-groups.adoc[アカウントグループを変更して複数のクラウドアカウントを含める]ことができます。
+
[NOTE]
====
xref:../../../alerts/create-an-alert-rule-cloud-infrastructure.adoc[実行時チェックのアラートルールを作成]し、アカウントグループを関連付けて、ポリシー違反が発生した場合にアラートを生成します。
====

.. *次へ*をクリックします。

. *レビューステータス*。
+
image::connect/gcp-add-org-3.png[]
+
GCP 組織の *詳細* と、Prisma Cloud で組織をオンボーディングするときに選択した*セキュリティ機能*のステータスチェックを確認します。

.. 選択したすべてのセキュリティ機能に緑色の *有効*アイコンが表示されていることを確認します。

.. 赤色の「*Checks Failed（チェック失敗）*」アイコンが表示されているセキュリティ機能については、対応するドロップダウンをクリックして、失敗の原因を確認します。

.. [*保存して閉じる*] をクリックしてオンボーディングを完了するか、[*保存して別のアカウントを登録*] をクリックします。
+
Prisma Cloud でGCP組織のオンボーディングに成功すると、そのアカウントはランタイムセキュリティで自動的に利用可能になり、*ワークロード検出* と *サーバーレスファンクションスキャン*が有効になります。*エージェントレス スキャン*の場合、スキャンをトリガーするための構成を完了する必要があります。
+
新しくオンボーディングされた GCP 組織は、*クラウドアカウントページ*で確認できます。
+
ネストされたプロジェクトがある場合、自動作成されたアカウントグループがPrisma Cloudに表示されるまで10 ～ 30分かかります。
+
[NOTE]
====
プロジェクトがPrisma Cloudに表示されるまでに最長で30分かかります。
====
+
*Cloud Accounts（クラウドアカウント）*ページでステータスを確認し、必要に応じてオンボーディングプロセス時に発生した問題に対処することができます。フローデータのエクスポートと分析には約4～24時間ほどかかり、それ以降でないとPrisma Cloudでレビューすることはできません。GCP組織からのフローログデータが分析されたかどうかを確認するために、*Investigate（調査）*ページでネットワーククエリを実行することができます。
+
[NOTE]
====
* Prisma Cloud上のGCP Organizationを削除して24時間以内に再登録した場合、これらのアカウントに関連するすべての既存のデータを復元できます。24 時間後、データはPrisma Cloudから削除されます。
* Prisma Cloudはサービスアカウントに関連するすべてのプロジェクトにアクセスできるため、サービスアカウントに関連するプロジェクトへのアクセス権を削除したい場合は、GCP IAMコンソールでサービスアカウントからプロジェクトを削除する必要があります。この場合、次回のセキュリティサイクルで、Prisma Cloudからプロジェクトが除外され、そのプロジェクトにアクセスできなくなります。
====

. *Cloud Accounts（クラウドアカウント）*に移動して、目的のGCPアカウントを探し、ステータスを参照してください。
+
image::connect/gcp-add-org-4.png[]

.. Prisma Cloudにオンボーディングされているプロジェクトを確認します。

.. クラウドアカウント名を選択し、プロジェクトのリストを確認して、以前に行った含む/除外の選択を確認します。
//+image::connect/gcp-add-org-5.png[]
