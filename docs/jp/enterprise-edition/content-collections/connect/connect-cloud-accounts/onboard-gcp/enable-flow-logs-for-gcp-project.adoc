:topic_type: タスク
[.task]
== GCP プロジェクトのフローログを有効にする
GCP プロジェクトのフロー ログを有効にします。

VPCフローログは、GCPプロジェクト内に展開されているリソースのフロー情報を視覚化するために役立ちます。GCPのVPCフローログは、ソースポートと宛先ポートでやり取りされるネットワークパケットのレコード、エンドポイントIPアドレスとポートを接続する個別のピア数など、VPCの一部であるネットワークインターフェイスでやり取りされる、フローレベルのネットワーク情報を提供しています。これを利用して、ネットワークの観点からアプリケーションを監視することができます。*Investigate（調査）*ページでは、共用VPCネットワークおよびファイアウォールルールを使用している、各サービスプロジェクト間および/またはホストプロジェクト間の仮想マシンのトラフィックフローを参照することができます。

[NOTE]
====
VPCフローログはVPCネットワーク上でのみサポートされています。GCPhttps://cloud.google.com/vpc/docs/legacy[レガシーネットワーク]ではサポートされていません。
====

Prisma Cloudでこれらのログを分析するには、各VPCサブネットでVPCフローログを有効にして、各ログエントリのコピーを保持する_シンク_にログをエクスポートする必要があります。Prisma Cloudでは、フローログを単一のクラウドストレージバケットにエクスポートする必要があります。これは、環境内のすべてのVPCフローログを保持する、シンク宛先として機能します。これらのログを取り込むようにPrisma Cloudを設定することで、このデータを分析して、ネットワークトラフィックの状況を把握したり、クリプトマイニング、データ抜き取り、ホストの不正利用などの潜在的なネットワーク脅威を検出したりすることができます。

Prisma CloudはGoogle Cloud Dataflowサービスを使ってVPCフローログ圧縮を自動化し、取り込むことを目的にして、それをストレージバケットに保存します。ストレージバケットからPrisma Cloudに未加工のGCPフローログを転送すると、データコストがかさむ可能性があります。そこで、Google Cloud Dataflowサービスとログ圧縮を有効にすることを検討してください。Cloud Dataflow ジョブのパイプラインを作成して実行する権限があることを確認するには、 xref:flow-logs-compression.adoc[GCP でのフロー ログの圧縮]を参照してください。

フローログを有効にすると、外向きネットワークトラフィックのコストが高くなります。Prisma Cloudでは、Prisma Cloudインフラに非圧縮GCPログを送信することにより発生する外向きネットワークトラフィックのコストを大幅に減らすために、xref:flow-logs-compression.adoc[GCPでフローログの圧縮]を有効にすることを強くお勧めします。

[.procedure]
. GCPでVPCネットワークのフローログを有効にします。
+
ネットワークトラフィックを分析するには、Prisma Cloudに監視させる各プロジェクトに対してフローログを有効にする必要があります。
+
.. https://console.cloud.google.com/[GCPコンソール]にログインして、プロジェクトを選択します。

.. *Navigation menu（ナビゲーションメニュー）> VPC network（VPCネットワーク）> VPC networks（VPCネットワーク）*の順に選択します。
+
image::connect/gcp-flow-logs-vpc-network.png[]

.. VPCネットワークを選択して、*EDIT（編集）*をクリックします。

.. *Flow logs（フローログ）* *On（オン）*の順に選択して、フローログを有効にします。
+
image::connect/gcp-enable-flow-logs.png[]

.. *[メタデータを含める]*を選択します。
+
この設定により、トラフィックの分析に必要なメタデータがログエントリに含まれるようになります。

.. *Aggregation Interval（集計間隔）*に*15 min（15分）*を設定します。

.. *Sample rate（サンプルレート）*に100%を設定します。
+
[NOTE]
====
集計間隔とサンプルレートを上記の推奨値に設定すると、Prisma Cloudでのアラート生成が速くなり、ネットワークコストを削減することができます。
====

.. 変更を*保存*します。

. (tt:[クラウドアカウントの追加にTerraformテンプレートを使用していない場合は必須])VPCフローログを収集するバケットにアクセス許可を追加します。
+
ストレージバケット内のオブジェクトをリストし、バケット内に格納されているオブジェクトデータとメタデータを読み取るために、Prisma Cloudサービスプリンシパル権限を付与する必要があります。必要な権限はuserinput:[storage.objects.list] と userinput:[storage.objects.get]です。Prisma Cloudがオンボーディングを有効にするために提供するTerraformテンプレートには*Prisma Cloud Flow Logs Viewer（Prisma Cloudフローログ閲覧者）*というロールにこれらの権限が含まれています。このロールは、オンボーディングフローで*フローログストレージバケット*を提供するバケット名のサービスアカウントに割り当てられます。これらの権限を手動で追加する場合は、Googleクラウドストレージのマニュアル（https://cloud.google.com/storage/docs/access-control/using-iam-permissions#bucket-add）を参照してください。

. フローログをエクスポートするために、シンクを作成します。
+
シンクを作成して、VPCフローログのエクスポート先としてクラウドストレージバケットを指定する必要があります。Prisma Cloudに監視させる各プロジェクトに対してシンクを設定して、すべてのプロジェクトのシンク宛先として単一のクラウドストレージバケットを設定する必要があります。xref:onboard-gcp-project.adoc[GCP プロジェクトをオンボーディング]する場合、サービスが VPC フロー ログを取り込むことができる クラウドストレージバケットを提供する必要があります。コストを削減するために、クラウドストレージバケットからログを削除するライフサイクルを設定することをお勧めします。
+
.. GCPへの認証中に、*Navigation menu(ナビゲーションメニュー)> Logging（ログ）> Legacy Logs Viewer（レガシーログビューア）> Upgrade（アップグレード）> Upgrade to the new Logs Explorer（新しいログエクスプローラーに更新）*を選択して、新しいログエクスプローラーに切り替えます。

.. シンクを作成します。
+
*Logging（ログ）> Log Router（ログルーター）> Create Sink（シンクを作成）*を選択します。
+
image::connect/gcp-flow-logs-stackdriver-logging.png[]

.. シンクの詳細を入力します。
+
* *シンク名* - シンクの識別子。
* *(tt:[任意]) *シンクの説明**-シンクのユースケース。
* *次へ*をクリックします。

.. シンクの宛先を入力します。
+
サービスタイプとログのルーティング先を選択します。
+
* *シンクサービスを選択* - ログをルーティングするサービスを選択します。フローログのシンクを作成する場合は、*Cloud Storage Bucket（クラウドストレージバケット）*を選択します。
* *シンクの宛先* — *Browse（参照）*をクリックして、使用するバケットを*選択します*。
* *次へ*をクリックします。

.. シンクに含めるログを選択します。
+
ルーティング シンクに含めるログを決定するための包含フィルターを作成します。+
*ビルド包含フィルター*で、次の操作を行います。
+
* *フィルタ式を入力* - 含めるログエントリに一致するフィルタを追加します。たとえば、すべてのデータアクセスログを単一のロギングバケットにルーティングするフィルターを作成する場合、フィルターは以下のようになります。
+
userinput:[logName:("projects/text-project-351281/logs/compute.googleapis.com%2Fvpc_flows") AND resource.labels.subnetwork_id:(5271207857644187590)] 

* *フィルターを検証* - 入力したフィルターが正しいことを確認するには、*Preview logs（ログをプレビュー）*を選択します。ログエクスプローラーが新しいタブで開き、フィルターがあらかじめ入力されています。
* *次へ*をクリックします。
* *Create Sink（シンクを作成）*をクリックします。

.. クラウドストレージバケットにフローログを保管する日数を制限するために、ライフサイクルルールを追加します。
+
デフォルトでは、ログが削除されることはありません。コストを管理するために、ログを保管するしきい値（日数）を指定します。

... *Navigation Menu（ナビゲーションメニュー）> Cloud Storage（クラウドストレージ）> Browser（ブラウザ）*の順に選択します。

... 変更するストレージバケットの*Lifecycle（ライフサイクル）*リンクを選択します。
+
image::connect/gcp-storage-bucket-lifecycle1.png[]

... *Add rule（ルールを追加）*して、Select object conditions（オブジェクト条件の選択）で*Age（期間）*を30日に、Select Action（アクションの選択）を*Delete（削除）*に設定します。
+
クラウドストレージバケットに保管されるログは、30日で削除されます。

... *Continue（続行）*を選択し、変更内容を*Save（保存）*します。

. xref:onboard-gcp-project.adoc[GCP プロジェクトをオンボーディングする]ときに、上記で参照した クラウドストレージバケットの名前を *Flow Logs Storage Bucket* に追加します。

. tt:[(任意)] クラウドストレージバケットが取り込まれていることを確認します。
+
*Cloud Accounts（クラウドアカウント）*ページでステータスを確認し、必要に応じてオンボーディングプロセス時に発生した問題に対処することができます。クラウドストレージバケットからのフローログデータが分析されたかどうかを確認するために、*Investigate（調査）*ページでネットワーククエリを実行することができます。
+
.. xref:onboard-gcp-project.adoc[GCP プロジェクトのオンボーディングします]。

.. Prisma Cloudで認証し、ストレージバケットが取り込まれていることを確認します。
+
*Settings（設定）> Cloud Accounts（クラウドアカウント）*を選択し、GCPクラウドアカウントをフィルタリングします。*Actions（アクション）* 列の*Edit（編集）*アイコンをクリックして、結果を表示します。

.. *Investigate（調査）*に移動して、名前をGCPクラウドアカウント名に変更して、以下のネットワーククエリを入力します。
+
----
network from vpc.flow_record where cloud.account = ‘{{cloud account name}}’ AND source.publicnetwork IN (‘Internet IPs’, ‘Suspicious IPs’) AND bytes > 0
----
+
このクエリは、インターネットまたは不審なIPアドレスから、クラウド環境にある任意のリソース上のネットワークインターフェイスに、0バイトを超えるデータを転送した、すべてのネットワークトラフィックを表示します。